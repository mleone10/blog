<!doctype html><html><head><link rel=stylesheet href=/css/ditalini.css><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css><title>Mario Leone | Introducing Dux, the Tiny Live Reload Tool</title></head><body><nav class="mainNav fullWidth"><h1><a href=https://mleone.dev>Mario Leone</a></h1><ul><li><a href=/about/>About Me</a></li><li><a href=https://mleone.dev/tags/>Tags</a></li></ul></nav><main><article class="single h-entry"><header><h2><a class="p-name u-url" href=https://mleone.dev/posts/dux/>Introducing Dux, the Tiny Live Reload Tool</a></h2><span class=byline><a class="p-author h-card" href=https://mleone.dev>Mario Leone</a>
&#183;&nbsp;<time class=dt-published datetime=2023-06-11T10:34:06-0400>
June 11, 2023</time>
&#183;
<a class=p-category href=https://mleone.dev/tags/go/>Go</a>, <a class=p-category href=https://mleone.dev/tags/software/>Software</a></span></header><div class=e-content><p>Last week, I was playing around with Go&rsquo;s <code>html/template</code> library and HTMX when I encountered a problem. Every time I made a change to an HTML template or the server code, I had to <code>Ctrl-C</code> to stop the server, then <code>go run main.go</code> to rerun it. That felt like something I could automate!</p><p>A quick search revealed that a tool called <a href=https://github.com/cosmtrek/air>Air</a> was widely recommended, but the problem still seemed easy enough to tackle myself.</p><p>After a few evenings of hacking at it, I think it&rsquo;s ready for my use case. I give you, <strong><a href=https://github.com/mleone10/dux>dux</a></strong>.</p><p>Dux is tiny. The bulk of the logic is 159 lines of Go, and that includes a couple nonessential bits. It also only uses Go standard library.</p><h2 id=how-it-works>How it works</h2><p>Dux has two parts: <strong>Engines</strong> and <strong>Watchers</strong>. A Watcher implements a <code>Watch(context.Context)</code> method that just blocks until a condition is met. I&rsquo;ve implemented two as an example: <code>FileWatcher</code> which monitors an <code>fs.FS</code> for changes, and <code>TimeWatcher</code> which waits for a certain <code>time.Duration</code> to elapse.</p><p>Engines, meanwhile, use Watchers to know when to do something. That &ldquo;something&rdquo; can be either a command and arguments (as in the case of <code>ExecEngine</code>) or a compatible function (for the <code>FuncEngine</code>). When the Engine starts, it executes its &ldquo;thing&rdquo; and waits for the Watcher to unblock. When it does, the Engine stops the &ldquo;thing&rdquo;, restarts it, and reruns the Watcher. It executes this loop forever, or until its context is canceled.</p><p>I also built a small command line application (<code>dux</code>) that combines an <code>ExecEngine</code> with a <code>FileWatcher</code>. This solves my initial use case, allowing me to reload my <em>other</em> side project whenever I make a change:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>dux -c <span style=color:#e6db74>&#34;go run main.go&#34;</span>
</code></pre></div><h2 id=challenges>Challenges</h2><p>I faced two main challenges in building this. The first was how to monitor files for changes. For this I got to learn a bit about Go&rsquo;s file system package and types. I use its <code>fs.WalkDir(...)</code> method to spin up a goroutine for every file in the file system, and a cancelable <code>context.Context</code> to signal that a file has changed and that all of the goroutines should quit. This was a fun foray into goroutines, contexts, and Go&rsquo;s <code>select</code> statement.</p><p>The second challenge was how to stop processes, specifically how to stop processes <em>and their children</em>. By default, stopping an <code>exec.Cmd</code> by canceling its context only kills that command&rsquo;s process, not any of its children. To get around this, I had to relearn some concepts of process management from college.</p><p>As I understand it, when a processes started via a Go <code>exec.Cmd</code> spawn a child process, those children to not share a &ldquo;process group ID&rdquo; (or &ldquo;pgid&rdquo;). As a result, stopping the parent process does not stop the children. We have to explicitly configure the <code>Cmd</code> to ensure that pgid is passed on:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#a6e22e>cmd</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>exec</span>.<span style=color:#a6e22e>Command</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Cmd</span>, <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Args</span><span style=color:#f92672>...</span>)
<span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>SysProcAttr</span> = <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>SysProcAttr</span>{<span style=color:#a6e22e>Setpgid</span>: <span style=color:#66d9ef>true</span>}

<span style=color:#66d9ef>go</span> <span style=color:#66d9ef>func</span>() {
  <span style=color:#f92672>&lt;-</span><span style=color:#a6e22e>ctx</span>.<span style=color:#a6e22e>Done</span>()
  <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>Kill</span>(<span style=color:#f92672>-</span><span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Process</span>.<span style=color:#a6e22e>Pid</span>, <span style=color:#a6e22e>syscall</span>.<span style=color:#a6e22e>SIGKILL</span>)
}()

<span style=color:#66d9ef>go</span> <span style=color:#a6e22e>cmd</span>.<span style=color:#a6e22e>Run</span>()
</code></pre></div><p>In this snippet, I create an <code>exec.Cmd</code> and set its <code>Setpgid</code> parameter to <code>true</code>. I then start a goroutine which waits for a context to be canceled. <code>&lt;-ctx.Done()</code> blocks until then, at which point it issues a <code>SIGKILL</code> signal to the command&rsquo;s <em>negative</em> PID (process ID). This is process-speak for &ldquo;stop this entire process group&rdquo;.</p><p>I was originally using <code>exec.CommandContext(...)</code> to create a process that could be stopped by canceling the registered context, but this combined with the above child-stopping goroutine had an unfortunate side effect. It seemed like the <em>parent</em> process was being stopped first, then the children. As best I can tell, the children would be terminated, but their processes would linger as there was no parent to read their exit code. The result was numerous zombie processes being left behind until the main <code>dux</code> application was stopped. Since the above goroutine worked to stop the parent process as well as its children, there was no need to tie the context to it as well.</p><h2 id=closing>Closing</h2><p>Overall, I&rsquo;m pretty proud of this little library and executable. It feels clean, lightweight, and useful. Most importantly, it feels sufficiently complete to use.</p><p>There are still parts that can be improved: I can add tests, modify the file-watching code to detect new or deleted files, and extend the command line capabilities. But those can come later.</p><p>I really enjoyed this particular side project. I think it was perfectly sized for a weekend. If this is the kind of pace and scale I can aspire to in the future, I&rsquo;ll be a happy software engineer!</p><section style=float:right;margin-right:2vh><h4 style=margin-bottom:0>Until next time,</h4><p style=margin-top:0;padding-left:2rem>&ndash; Mario Leone</p></section></div></article></main><footer class="fullWidth h-card"><img class=u-photo src=/profilePic.jpeg>
<span><p class=p-note>Hi, I'm Mario! Software engineering manager, actor, DIY-enthusiast. Trying new things every day and living life to the fullest!</p><p>&copy;
2023
<a class="p-name u-url u-uid" href=https://mleone.dev>Mario Leone</a>
<a class=u-url rel=me href=https://github.com/mleone10><i class="fa-brands fa-github"></i></a><a class=u-url rel=me href=https://linkedin.com/in/mleone5244><i class="fa-brands fa-linkedin"></i></a><a class=u-url rel=me href=https://hachyderm.io/@mleone><i class="fa-brands fa-mastodon"></i></a></p></span></footer></body></html>